#!/usr/bin/env bash
# faw_ytmusicdl ‚Äî —Å–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫ —Å YouTube/YouTube Music –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ MP3
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   faw_ytmusicdl <url> [title] [artist]

set -euo pipefail

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
for cmd in yt-dlp ffmpeg; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è $cmd. –£—Å—Ç–∞–Ω–æ–≤–∏ –µ–≥–æ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º."
        exit 1
    fi
done

if [ -z "${1:-}" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: faw_ytmusicdl <url> [title] [artist]"
    exit 1
fi

URL="$1"
TITLE="${2:-}"
ARTIST="${3:-}"

# === –ü—É—Ç–∏ ===
TMPFILE="$(mktemp /tmp/ytmusicdl.XXXXXX.webm)"   # –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
OUTDIR="$(pwd)"                                  # —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞
cd "$OUTDIR"

# === –°–∫–∞—á–∏–≤–∞–Ω–∏–µ ===
echo "üîΩ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ..."
yt-dlp \
    -f "bestaudio[ext=webm]/bestaudio" \
    -o "$TMPFILE" \
    --no-playlist \
    --no-part \
    --no-cache-dir \
    --quiet --progress \
    "$URL" || {
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏."
        rm -f "$TMPFILE"
        exit 1
    }

# === –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ===
if [ -z "$TITLE" ]; then
    TITLE=$(yt-dlp --get-title "$URL" 2>/dev/null || echo "unknown_title")
fi

OUTFILE="${OUTDIR}/${TITLE// /_}.mp3"

# === –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ===
echo "üéß –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MP3..."
if [ -n "$ARTIST" ]; then
    ffmpeg -y -i "$TMPFILE" -vn -ar 44100 -ac 2 -b:a 192k \
        -metadata title="$TITLE" -metadata artist="$ARTIST" \
        "$OUTFILE" < /dev/null
else
    ffmpeg -y -i "$TMPFILE" -vn -ar 44100 -ac 2 -b:a 192k \
        -metadata title="$TITLE" \
        "$OUTFILE" < /dev/null
fi

# === –û—á–∏—Å—Ç–∫–∞ ===
rm -f "$TMPFILE"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ: $OUTFILE"

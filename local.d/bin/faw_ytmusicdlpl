#!/usr/bin/env bash
# faw_ytmusicdlpl ‚Äî —Å–∫–∞—á–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç YouTube/YouTube Music –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç—Ä–µ–∫–∏ –≤ –æ–¥–∏–Ω MP3
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   faw_ytmusicdlpl <playlist_url> <output_title> [artist]

set -euo pipefail

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ===
for cmd in yt-dlp ffmpeg; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è $cmd. –£—Å—Ç–∞–Ω–æ–≤–∏ –µ–≥–æ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º."
        exit 1
    fi
done

if [ -z "${1:-}" ] || [ -z "${2:-}" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: faw_ytmusicdlpl <playlist_url> <output_title> [artist]"
    exit 1
fi

PLAYLIST_URL="$1"
OUT_TITLE="$2"
ARTIST="${3:-Unknown Artist}"

# === –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –≤—ã—Ö–æ–¥–Ω—ã–µ –ø—É—Ç–∏ ===
WORKDIR="$(mktemp -d /tmp/ytdlpl.XXXXXX)"
OUTDIR="$(pwd)"
FINAL_MP3="${OUTDIR}/${OUT_TITLE// /_}.mp3"

echo "üìÇ –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞: $WORKDIR"
cd "$WORKDIR"

# === –®–∞–≥ 1: –°–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –∏–∑ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ===
echo "üìú –ü–æ–ª—É—á–∞—é —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ..."
yt-dlp --flat-playlist --get-id "$PLAYLIST_URL" > ids.txt

if [ ! -s ids.txt ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ."
    exit 1
fi

# === –®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–∫–∞ ===
n=0
while IFS= read -r ID; do
    n=$((n + 1))
    echo "üéµ [$n] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ: $ID"
    TRACK_URL="https://www.youtube.com/watch?v=$ID"

    TITLE=$(yt-dlp --get-title "$TRACK_URL" 2>/dev/null || echo "track_$n")
    SAFE_TITLE="${TITLE// /_}"
    OUTFILE="${WORKDIR}/${SAFE_TITLE}.mp3"

    # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
    yt-dlp -f "bestaudio[ext=webm]/bestaudio" -o - "$TRACK_URL" \
        | ffmpeg -y -i pipe:0 -vn -ar 44100 -ac 2 -b:a 192k \
        -metadata title="$TITLE" -metadata artist="$ARTIST" \
        "$OUTFILE" < /dev/null || {
            echo "‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω: $TITLE"
            continue
        }
done < ids.txt

# === –®–∞–≥ 3: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö MP3 ===
echo "üß© –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤..."

# –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è ffmpeg
find . -type f -name "*.mp3" -printf "file '%p'\n" | sort > files.txt

if [ ! -s files.txt ]; then
    echo "‚ùå –ù–µ—Ç MP3-—Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è."
    exit 1
fi

ffmpeg -f concat -safe 0 -i files.txt -c copy \
    -metadata title="$OUT_TITLE" -metadata artist="$ARTIST" \
    "$FINAL_MP3" < /dev/null

# === –û—á–∏—Å—Ç–∫–∞ ===
rm -rf "$WORKDIR"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ: $FINAL_MP3"

#!/usr/bin/env bash

# faw_ytmusicdl_playlist ‚Äî —Å–∫–∞—á–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ MP3 –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å

set -euo pipefail

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ===
for cmd in yt-dlp ffmpeg; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è $cmd. –£—Å—Ç–∞–Ω–æ–≤–∏ –µ–≥–æ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º."
        exit 1
    fi
done

if [ -z "${1:-}" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  faw_ytmusicdl_playlist <playlist_url> [title] [artist]"
    exit 1
fi

URL="$1"
TITLE="${2:-}"
ARTIST="${3:-}"

# === –ü—É—Ç–∏ ===
WORKDIR="$(mktemp -d /tmp/ytmusicdl_playlist.XXXXXX)"
OUTDIR="$(pwd)"
CONCAT_LIST="$WORKDIR/concat.txt"

# === –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ===
if [ -z "$TITLE" ]; then
    TITLE=$(yt-dlp --get-playlist-title "$URL" 2>/dev/null || echo "playlist")
fi

OUTFILE="${OUTDIR}/${TITLE// /_}.mp3"

echo "üìÇ –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞: $WORKDIR"
echo "üéº –ü–ª–µ–π–ª–∏—Å—Ç: $TITLE"

# === –°–∫–∞—á–∏–≤–∞–Ω–∏–µ ===
echo "üîΩ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ..."
yt-dlp \
    -f "bestaudio[ext=webm]/bestaudio" \
    -o "$WORKDIR/%(playlist_index)03d - %(title)s.%(ext)s" \
    --yes-playlist \
    --no-part \
    --no-cache-dir \
    --quiet --progress \
    "$URL"

# === –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MP3 ===
echo "üéß –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ MP3..."
for file in "$WORKDIR"/*.webm "$WORKDIR"/*.m4a "$WORKDIR"/*.opus; do
    [ -e "$file" ] || continue
    mp3="${file%.*}.mp3"

    ffmpeg -y -i "$file" -vn -ar 44100 -ac 2 -b:a 192k \
        "$mp3" < /dev/null

    rm -f "$file"
done

# === –°–ø–∏—Å–æ–∫ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è ===
for mp3 in "$WORKDIR"/*.mp3; do
    echo "file '$mp3'" >> "$CONCAT_LIST"
done

# === –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ===
echo "üß© –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤..."
if [ -n "$ARTIST" ]; then
    ffmpeg -y -f concat -safe 0 -i "$CONCAT_LIST" \
        -metadata title="$TITLE" \
        -metadata artist="$ARTIST" \
        -c copy "$OUTFILE" < /dev/null
else
    ffmpeg -y -f concat -safe 0 -i "$CONCAT_LIST" \
        -metadata title="$TITLE" \
        -c copy "$OUTFILE" < /dev/null
fi

# === –û—á–∏—Å—Ç–∫–∞ ===
rm -rf "$WORKDIR"

echo "‚úÖ –ì–æ—Ç–æ–≤–æ: $OUTFILE"
